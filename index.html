<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <!-- 关键优化：移动端视口配置，适配全屏，禁止缩放 -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>精神红包雨 · 手机优化版</title>
  <style>
    :root{
      --bg1:#0b1020;
      --bg2:#1a0b1e;
      --card:#ffffff10;
      --text:#f7f7fb;
      --muted:#c9c9d6;
      --accent:#ff4d6d;
      --gold:#ffd166;
      --good:#6ee7b7;
      --bad:#fb7185;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"PingFang SC","Noto Sans SC","Helvetica Neue",Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 20% 10%, #3b1b5d55, transparent 60%),
        radial-gradient(900px 700px at 80% 20%, #ff4d6d33, transparent 60%),
        linear-gradient(160deg, var(--bg1), var(--bg2));
      height:100vh;
      overflow:hidden;
      /* 关键优化：禁止页面整体滚动，避免误触 */
      overscroll-behavior: none;
      -webkit-tap-highlight-color: transparent;
    }
    .wrap{
      max-width: 520px;
      margin: 0 auto;
      height:100vh;
      padding: 16px 14px 18px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
    }
    .logo{
      width:40px; height:40px; border-radius:14px;
      background: linear-gradient(135deg, #ff4d6d, #ffd166);
      box-shadow: var(--shadow);
      display:grid; place-items:center;
      font-weight:900;
      color:#200a14;
    }
    .title{
      display:flex; flex-direction:column; gap:2px;
      line-height:1.15;
    }
    .title b{font-size:16px}
    .title span{font-size:12px; color:var(--muted)}
    .pill{
      padding:10px 12px;
      border-radius: 999px;
      background: var(--card);
      backdrop-filter: blur(12px);
      box-shadow: var(--shadow);
      display:flex;
      gap:10px;
      align-items:center;
      font-size:13px;
      color:var(--muted);
    }
    .stats{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
    }
    .card{
      background: var(--card);
      border:1px solid #ffffff1a;
      border-radius: var(--radius);
      padding: 12px 12px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      min-height: 62px;
    }
    .k{font-size:12px; color:var(--muted)}
    .v{margin-top:4px; font-size:18px; font-weight:800}
    .v small{font-size:12px; color:var(--muted); font-weight:600}
    .game{
      flex:1;
      position:relative;
      border-radius: 22px;
      overflow:hidden;
      background:
        radial-gradient(900px 400px at 50% 0%, #ffffff10, transparent 55%),
        linear-gradient(180deg, #00000030, #00000055);
      border:1px solid #ffffff1a;
      box-shadow: var(--shadow);
      /* 关键优化：专门针对移动端触控的设置 */
      touch-action: manipulation;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }

    /* little sparkles */
    .spark{
      position:absolute;
      inset:0;
      pointer-events:none;
      background-image:
        radial-gradient(2px 2px at 20% 30%, #ffffffaa, transparent 60%),
        radial-gradient(1.5px 1.5px at 70% 25%, #ffd166aa, transparent 60%),
        radial-gradient(1.8px 1.8px at 40% 60%, #ff4d6daa, transparent 60%),
        radial-gradient(1px 1px at 85% 70%, #ffffffaa, transparent 60%),
        radial-gradient(2px 2px at 15% 80%, #6ee7b7aa, transparent 60%);
      opacity:.7;
      filter: blur(.1px);
    }

    .hud{
      position:absolute;
      left:12px; right:12px; top:12px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      pointer-events:none;
    }
    .hud .chip{
      pointer-events:none;
      padding:8px 10px;
      border-radius:999px;
      background:#00000035;
      border:1px solid #ffffff25;
      backdrop-filter: blur(10px);
      font-size:12px;
      color:#eaeaf4;
      display:flex;
      gap:8px;
      align-items:center;
    }
    .hud .chip i{
      width:8px;height:8px;border-radius:99px;background:var(--good);
      display:inline-block;
      box-shadow:0 0 12px #6ee7b799;
    }
    .hud .chip.danger i{background: var(--bad); box-shadow:0 0 12px #fb718599;}

    .center{
      position:absolute;
      inset:0;
      display:grid;
      place-items:center;
      padding: 18px;
      text-align:center;
    }
    .panel{
      width:min(440px, 92%);
      background: #00000045;
      border:1px solid #ffffff22;
      border-radius: 24px;
      padding: 18px 16px 16px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
    }
    .panel h1{
      margin:0 0 6px;
      font-size:20px;
      letter-spacing:.5px;
    }
    .panel p{
      margin:0 0 14px;
      color:var(--muted);
      font-size:13px;
      line-height:1.6;
    }
    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:center;
    }
    button{
      border:0;
      padding: 14px 16px; /* 优化：增大点击区域 */
      border-radius: 16px;
      font-weight:800;
      cursor:pointer;
      box-shadow: var(--shadow);
      transition: transform .08s ease;
      flex:1;
      min-width: 140px; /* 优化：确保按钮在手机上足够大 */
      /* 优化：增强触控反馈 */
      -webkit-tap-highlight-color: rgba(255, 255, 255, 0.2);
    }
    button:active{ transform: translateY(1px) scale(.97); }
    .btn-primary{
      color:#1b0a12;
      background: linear-gradient(135deg, var(--accent), var(--gold));
    }
    .btn-ghost{
      color:var(--text);
      background:#ffffff12;
      border:1px solid #ffffff22;
      backdrop-filter: blur(10px);
    }

    /* red packet */
    .packet{
      position:absolute;
      width: 68px; /* 优化：略微增大，便于手指点击 */
      height: 84px;
      border-radius: 16px;
      background: linear-gradient(180deg, #ff3b57, #cc0f2e);
      border:1px solid rgba(255,255,255,.25);
      box-shadow: 0 18px 26px rgba(0,0,0,.35);
      display:flex;
      align-items:center;
      justify-content:center;
      user-select:none;
      -webkit-user-select:none;
      transform: translate(-50%, -50%);
      will-change: transform, top, left;
      /* 优化：防止在手机上被长按选中 */
      -webkit-touch-callout: none;
    }
    .packet::before{
      content:"";
      position:absolute;
      top: 32px; left: 8px; right: 8px; /* 优化：适应新尺寸 */
      height: 10px;
      background: rgba(255, 209, 102, .95);
      border-radius: 8px;
      filter: drop-shadow(0 4px 10px rgba(0,0,0,.18));
    }
    .packet .coin{
      position:absolute;
      width: 18px; height: 18px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 30%, #fff3, transparent 55%),
                  linear-gradient(135deg, #ffe08a, #ffd166);
      top: 28px; /* 优化：位置调整 */
      box-shadow: 0 0 16px rgba(255, 209, 102, .35);
    }
    .packet .txt{
      position:absolute;
      bottom: 12px;
      font-size: 13px; /* 优化：略微增大字体 */
      font-weight: 900;
      letter-spacing: .5px;
      color: #ffe9ef;
      opacity: .95;
    }
    .packet.big{
      width: 76px;
      height: 94px;
      background: linear-gradient(180deg, #ff5a7a, #c70f2e);
      filter: drop-shadow(0 0 18px rgba(255, 209, 102, .22));
    }
    .pop{
      position:absolute;
      transform: translate(-50%, -50%);
      font-weight:900;
      pointer-events:none;
      text-shadow: 0 10px 18px rgba(0,0,0,.35);
      animation: pop .65s ease forwards;
    }
    @keyframes pop{
      0%{opacity:0; transform: translate(-50%, -20%) scale(.9)}
      20%{opacity:1; transform: translate(-50%, -50%) scale(1.02)}
      100%{opacity:0; transform: translate(-50%, -90%) scale(1)}
    }
    .shake{
      animation: shake .16s ease-in-out 2;
    }
    @keyframes shake{
      0%{transform: translateX(0)}
      25%{transform: translateX(-2px)}
      50%{transform: translateX(2px)}
      75%{transform: translateX(-2px)}
      100%{transform: translateX(0)}
    }
    .footer{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
      padding-top:2px;
    }
    .hint{
      font-size:12px;
      color:var(--muted);
      line-height:1.4;
    }
    .mini{
      display:flex;
      gap:8px;
      align-items:center;
    }
    .tag{
      font-size:12px;
      padding:7px 10px;
      border-radius: 999px;
      background:#ffffff10;
      border:1px solid #ffffff1f;
      color: #e9e9f6;
    }
    .kbd{
      font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;
      font-size:12px;
      padding: 2px 6px;
      border-radius: 8px;
      background:#00000040;
      border:1px solid #ffffff24;
      color:#eaeaf4;
    }
    .hidden{
      display:none !important;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo">🧧</div>
        <div class="title">
          <b>精神红包雨 · 手机优化版</b>
          <span>单指狂点，接住爽感 🌟</span>
        </div>
      </div>
      <div class="pill" id="statusPill">状态：<b style="color:#fff">准备开始</b></div>
    </div>

    <div class="stats">
      <div class="card">
        <div class="k">当前得分</div>
        <div class="v"><span id="score">0</span> <small>pts</small></div>
      </div>
      <div class="card">
        <div class="k">连击</div>
        <div class="v"><span id="combo">0</span> <small>x</small></div>
      </div>
      <div class="card">
        <div class="k">剩余时间</div>
        <div class="v"><span id="time">20</span> <small>s</small></div>
      </div>
    </div>

    <div class="game" id="game">
      <div class="spark"></div>

      <div class="hud">
        <div class="chip" id="chip1"><i></i> 小红包：+1～3</div>
        <div class="chip danger" id="chip2"><i></i> 大红包：+8（稀有）</div>
      </div>

      <div class="center" id="startScreen">
        <div class="panel">
          <h1>手指准备好 😋🧧</h1>
          <p>
            <b>单指点击</b>天上掉下来的红包即可接住！<br/>
            连续接住会叠加<b>连击</b>，获得额外分数。<br/>
            连击 ≥ 8 次会触发神秘<b>口令彩蛋</b>✨
          </p>
          <div class="row">
            <button class="btn-primary" id="btnStart">开始游戏 (20秒)</button>
            <button class="btn-ghost" id="btnHow">查看提示</button>
          </div>
          <p id="howText" class="hidden" style="margin-top:12px">
            💡 <b>手机技巧</b>：用拇指或食指快速点按，<br/>
            瞄准红包中间区域更容易命中。
          </p>
        </div>
      </div>

      <div class="center hidden" id="endScreen">
        <div class="panel">
          <h1 id="endTitle">游戏结束</h1>
          <p id="endDesc">——</p>
          <div class="row">
            <button class="btn-primary" id="btnRetry">再玩一次</button>
            <button class="btn-ghost" id="btnCopy">分享战绩</button>
          </div>
          <p style="margin-top:12px;color:var(--muted);font-size:12px;">
            点击「分享战绩」可以复制结果，发给朋友一起玩 📱
          </p>
        </div>
      </div>
    </div>

    <div class="footer">
      <div class="hint">
        专为手机触控优化，点按流畅，反馈及时。<br/>
        此版本已禁止页面滚动，专注抢红包 🎯
      </div>
      <div class="mini">
        <div class="tag">📱 触控优化</div>
        <div class="tag">⚡ 全屏沉浸</div>
        <div class="tag">✨ 手机特供</div>
      </div>
    </div>
  </div>

<script>
(() => {
  const game = document.getElementById('game');
  const startScreen = document.getElementById('startScreen');
  const endScreen = document.getElementById('endScreen');
  const btnStart = document.getElementById('btnStart');
  const btnRetry = document.getElementById('btnRetry');
  const btnCopy = document.getElementById('btnCopy');
  const btnHow = document.getElementById('btnHow');
  const howText = document.getElementById('howText');

  const scoreEl = document.getElementById('score');
  const comboEl = document.getElementById('combo');
  const timeEl = document.getElementById('time');
  const statusPill = document.getElementById('statusPill');

  const endTitle = document.getElementById('endTitle');
  const endDesc = document.getElementById('endDesc');

  let running = false;
  let score = 0;
  let combo = 0;
  let maxCombo = 0; // 新增：最高连击记录
  let timeLeft = 20;
  let tickTimer = null;
  let spawnTimer = null;

  // 调参区：针对手机性能优化
  const CFG = {
    duration: 20,            // 秒
    spawnEveryMs: 420,       // 掉落频率（数值越大，红包越稀疏，性能压力越小）【已调整】
    fallMsMin: 1200,         // 下落时间范围（数值越大，下落越慢）【已调整】
    fallMsMax: 1600,
    bigChance: 0.12,         // 大红包概率
    missComboBreak: 2        // 连续漏多少个断连
  };

  let missStreak = 0;
  let easterEggFired = false;

  function setStatus(text){
    statusPill.innerHTML = '状态：<b style="color:#fff">' + text + '</b>';
  }

  function rand(min, max){ return Math.random()*(max-min)+min; }
  function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }

  function reset(){
    score = 0;
    combo = 0;
    maxCombo = 0; // 重置最高连击
    timeLeft = CFG.duration;
    missStreak = 0;
    easterEggFired = false;
    scoreEl.textContent = score;
    comboEl.textContent = combo;
    timeEl.textContent = timeLeft;
    clearPackets();
  }

  function clearPackets(){
    [...game.querySelectorAll('.packet, .pop')].forEach(n => n.remove());
  }

  function start(){
    if(running) return;
    running = true;
    reset();
    startScreen.classList.add('hidden');
    endScreen.classList.add('hidden');
    setStatus('激烈抢购中');
    tickTimer = setInterval(tick, 1000);
    spawnTimer = setInterval(spawnPacket, CFG.spawnEveryMs);
  }

  function end(){
    running = false;
    clearInterval(tickTimer);
    clearInterval(spawnTimer);
    setStatus('抢购结束');
    showEnd();
  }

  function tick(){
    timeLeft -= 1;
    timeEl.textContent = timeLeft;
    if(timeLeft <= 0){
      timeLeft = 0;
      timeEl.textContent = 0;
      end();
    }
  }

  function spawnPacket(){
    if(!running) return;

    const rect = game.getBoundingClientRect();
    const x = rand(10, 90); // vw percent inside game
    const isBig = Math.random() < CFG.bigChance;

    const pkt = document.createElement('div');
    pkt.className = 'packet' + (isBig ? ' big' : '');
    pkt.style.left = x + '%';
    pkt.style.top = '-10px';

    const coin = document.createElement('div');
    coin.className = 'coin';
    const txt = document.createElement('div');
    txt.className = 'txt';
    txt.textContent = isBig ? '大红包' : '红包';

    pkt.appendChild(coin);
    pkt.appendChild(txt);

    const fallMs = rand(CFG.fallMsMin, CFG.fallMsMax) * (isBig ? 0.92 : 1);
    const startTop = -10;
    const endTop = rect.height + 40;

    let caught = false;

    // 【优化1】统一使用 pointerdown 事件监听，添加 { passive: false }
    pkt.addEventListener('pointerdown', handleCatch, { passive: false });

    function handleCatch(e) {
      if(!running || caught) return;
      // 【优化1】阻止默认行为，避免移动端额外手势
      e.preventDefault();
      caught = true;
      pkt.remove();
      // 获取正确的触点坐标
      const clientX = e.touches ? e.touches[0].clientX : e.clientX;
      const clientY = e.touches ? e.touches[0].clientY : e.clientY;
      onCatch(isBig, clientX, clientY);
    }

    // 动画：用 requestAnimationFrame 手搓，性能还行
    const startTs = performance.now();
    function step(ts){
      if(!running){
        pkt.remove();
        return;
      }
      const t = clamp((ts - startTs) / fallMs, 0, 1);
      const y = startTop + (endTop - startTop) * (t*t*0.9 + t*0.1); // ease-in-ish
      pkt.style.top = y + 'px';

      if(t >= 1){
        // 落地没接住
        if(!caught){
          pkt.remove();
          onMiss();
        }
        return;
      }
      requestAnimationFrame(step);
    }

    game.appendChild(pkt);
    requestAnimationFrame(step);
  }

  function onCatch(isBig, x, y){
    missStreak = 0;

    const add = isBig ? 8 : (Math.random() < 0.45 ? 3 : (Math.random() < 0.6 ? 2 : 1));
    combo += 1;
    
    // 【优化2】更新最高连击记录
    if (combo > maxCombo) maxCombo = combo;
    
    score += add + Math.floor(combo/6); // 连击小加成

    scoreEl.textContent = score;
    comboEl.textContent = combo;

    popText('+' + (add + Math.floor(combo/6)) + (isBig ? ' 💥' : ''), x, y, isBig);

    // 口令彩蛋：连击够了送一次“开奖”
    if(combo >= 8 && !easterEggFired){
      easterEggFired = true;
      setTimeout(() => {
        showEasterEgg();
      }, 280);
    }
  }

  function onMiss(){
    missStreak += 1;
    if(missStreak >= CFG.missComboBreak){
      if(combo > 0){
        combo = 0;
        comboEl.textContent = combo;
        shake(game);
        popCenter('连击断了 😭', '下次更稳一点点就行');
      }
      missStreak = 0;
    }
  }

  function popText(text, x, y, strong){
    const p = document.createElement('div');
    p.className = 'pop';
    p.textContent = text;
    p.style.left = x + 'px';
    p.style.top = y + 'px';
    p.style.fontSize = strong ? '18px' : '16px';
    p.style.color = strong ? 'var(--gold)' : '#fff';
    game.appendChild(p);
    setTimeout(() => p.remove(), 800);
  }

  function popCenter(title, desc){
    // 简易 toast：复用 endScreen 样式但不打断
    const toast = document.createElement('div');
    toast.style.position = 'absolute';
    toast.style.left = '50%';
    toast.style.top = '52%';
    toast.style.transform = 'translate(-50%, -50%)';
    toast.style.width = 'min(420px, 86%)';
    toast.style.padding = '14px 14px 12px';
    toast.style.borderRadius = '20px';
    toast.style.background = '#00000055';
    toast.style.border = '1px solid #ffffff25';
    toast.style.backdropFilter = 'blur(12px)';
    toast.style.boxShadow = 'var(--shadow)';
    toast.style.textAlign = 'center';
    toast.style.pointerEvents = 'none';

    toast.innerHTML = `
      <div style="font-weight:900;font-size:16px;margin-bottom:6px;">${title}</div>
      <div style="color:var(--muted);font-size:12px;line-height:1.5;">${desc}</div>
    `;
    game.appendChild(toast);
    setTimeout(() => toast.remove(), 900);
  }

  function showEasterEgg(){
    // 彩蛋：给一句“口令开奖”文案
    const lines = [
      '口令开奖：✨「灵感捕手」——今天你会突然抓到一个很妙的点子。',
      '口令开奖：🧠「脑洞大开」——你会把一个麻烦问题用更优雅的方式拆掉。',
      '口令开奖：🍀「心想事成」——你想要的那个小确幸，会比你想的更快出现。',
      '口令开奖：🔥「一发即中」——你下一次出手，比别人更准。',
      '口令开奖：🌙「星河入梦」——今晚睡前灵感会来敲门。'
    ];
    const pick = lines[Math.floor(Math.random()*lines.length)];
    popCenter('🎉 彩蛋触发！', pick);
  }

  function shake(el){
    el.classList.remove('shake');
    // force reflow
    void el.offsetWidth;
    el.classList.add('shake');
    setTimeout(() => el.classList.remove('shake'), 400);
  }

  function showEnd(){
    clearPackets();
    endScreen.classList.remove('hidden');

    const grade = score >= 120 ? '红包雨之王 👑' :
                  score >= 85 ? '手速型选手 ⚡' :
                  score >= 55 ? '稳稳幸福 😋' :
                  '慢慢来也很可爱 🌚';

    endTitle.textContent = grade;

    const msg = score >= 85
      ? '你这手速去平台活动里真能抢到！不夸张。'
      : '下次提前 3 秒准备，手感会立刻上来。';

    // 【优化2】展示 maxCombo 而不是当前的 combo
    endDesc.innerHTML = `
      你的得分：<b style="color:var(--gold)">${score}</b> 分 · 最高连击：<b style="color:var(--good)">${maxCombo}</b><br/>
      <span style="color:var(--muted);font-size:12px;line-height:1.6;display:inline-block;margin-top:6px;">
        ${msg}
      </span>
    `;
  }

  function copyResult(){
    const text = `我刚玩了「精神红包雨」手机版 🧧📱 得分 ${score}，最高连击 ${maxCombo}。\
虽然不是现金，但爽感是真的 🌟✨\n\n手机体验超流畅，你也试试？`;
    
    // 【优化4】增强的复制功能，支持 fallback
    const copyToClipboard = async (text) => {
      try {
        // 优先使用 navigator.clipboard API
        if (navigator.clipboard && window.isSecureContext) {
          await navigator.clipboard.writeText(text);
          return true;
        } else {
          // Fallback 方案：使用 textarea
          const textArea = document.createElement("textarea");
          textArea.value = text;
          textArea.style.position = "fixed";
          textArea.style.left = "-999999px";
          textArea.style.top = "-999999px";
          document.body.appendChild(textArea);
          textArea.focus();
          textArea.select();
          
          try {
            // 尝试使用旧版 execCommand
            const success = document.execCommand('copy');
            document.body.removeChild(textArea);
            return success;
          } catch (err) {
            document.body.removeChild(textArea);
            return false;
          }
        }
      } catch (err) {
        console.error('复制失败:', err);
        return false;
      }
    };

    copyToClipboard(text).then(success => {
      if (success) {
        popCenter('📋 已复制', '可以粘贴到微信或QQ分享啦~');
      } else {
        // 如果都失败了，提示用户手动复制
        const fallbackText = `无法自动复制，请手动复制以下内容：\n\n${text}`;
        popCenter('复制失败', '可以手动截图或复制文案分享哦 📸');
        console.log(fallbackText);
      }
    });
  }

  // UI hooks
  btnStart.addEventListener('pointerdown', start); // 【优化1】统一使用 pointerdown
  btnRetry.addEventListener('pointerdown', start);
  btnCopy.addEventListener('pointerdown', copyResult);
  btnHow.addEventListener('pointerdown', () => {
    howText.classList.toggle('hidden');
  });

  // 【优化1】统一使用 pointerdown，并添加 { passive: false }
  game.addEventListener('pointerdown', handleBlankTap, { passive: false });

  function handleBlankTap(e) {
    if(!running) return;
    
    // 【优化1】阻止默认行为
    e.preventDefault();
    
    // 【优化3】使用 closest 判断是否点击到红包
    const isPacket = e.target.closest?.('.packet');
    if(!isPacket){
      // 点到空白：轻微扣一点连击（但不扣分）
      const clientX = e.touches ? e.touches[0].clientX : e.clientX;
      const clientY = e.touches ? e.touches[0].clientY : e.clientY;

      missStreak += 1;
      if(missStreak >= CFG.missComboBreak){
        if(combo > 0){
          combo = 0;
          comboEl.textContent = combo;
          shake(game);
          popText('MISS', clientX, clientY, false);
        }
        missStreak = 0;
      }else{
        popText('…', clientX, clientY, false);
      }
    }
  }

  setStatus('准备开始');
})();
</script>
</body>
</html>
